# mfx Rail Format / M4 Track Protocol
**Unofficial Documentation (Version 2.3)**
[cite_start]*Based on the reverse engineering work by Stefan Krauss and Team* [cite: 2, 3, 5]

## 1. Disclaimer & Introduction
This document describes the mfx® rail signal as interpreted by the authors. [cite_start]It is not an official specification from Märklin. mfx is a registered trademark of Gebrüder Märklin & Cie. GmbH. [cite: 10, 11, 28]

## 2. Signal and Coding

### 2.1 Transmission Principle
* **Voltage:** Square wave alternating voltage of approx. [cite_start]±18 V. [cite: 111]
* [cite_start]**Encoding:** Biphase mark encoding (clock included in data stream). [cite: 147]
* [cite_start]**Speed:** 10 kBaud (1 bit = 100 µs). [cite: 148]
* **Logic:**
    * [cite_start]`1`: Polarity change in the middle of the clock cell. [cite: 151]
    * [cite_start]`0`: No polarity change within the clock cell. [cite: 152]
* **Synchronization:** A specific pattern violating the biphase rule. [cite_start]Sequence `0 1 1 1 0` (500 µs), where the polarity change is omitted between the 2nd/3rd and 3rd/4th bit. [cite: 168]

### 2.2 Framing
* [cite_start]**Bit Order:** Big Endian (MSB first). [cite: 222]
* **Stuffing:** After 8 consecutive `1` bits, a `0` is inserted (to ensure DCC compatibility). [cite_start]Stuffing is ignored for sync patterns. [cite: 216, 218]
* [cite_start]**Frame Structure:** `[Sync] [Address] [Command/Data] [Checksum] [Sync]` [cite: 242]

### 2.3 Address (SID)
* Dynamically assigned 32-bit UID mapped to a 14-bit short address (SID).
* SID Lengths vary (compressed):
    * [cite_start]7-bit: `10 AAAAAAA` [cite: 260]
    * [cite_start]9-bit: `110 AAAAAAAAA` [cite: 261]
    * [cite_start]11-bit: `1110 AAAAAAAAAAA` [cite: 262]
    * [cite_start]14-bit: `1111 AAAAAAAAAAAAAAA` [cite: 263]
* [cite_start]`0` is the Broadcast address. [cite: 264]

### 2.4 Checksum (CRC)
* [cite_start]8-bit CRC over all frame bits (excluding stuffing). [cite: 265, 279]
* [cite_start]**Polynomial:** $x^8 + x^2 + x + 1$ (0x93 or binary 100000111). [cite: 281]
* [cite_start]**Start Value:** `0x7F` (127). [cite: 281]
* [cite_start]**Final Value:** Must be `0` after processing the checksum byte. [cite: 282]

### 2.5 Feedback (Return Channel)
* [cite_start]**Technology:** Current pulses generated by the decoder, detected by the central station. [cite: 131]
* [cite_start]**Modulation:** RDS-like principle, Carrier Frequency ~52.63 kHz. [cite: 411]
* **Types:**
    1.  **1-Bit Feedback:** "Yes/No". Used for acknowledgment (ACK). [cite_start]Logic OR (multiple decoders can answer). [cite: 416, 419]
    2.  **Data Feedback:** Transmits 1, 2, 4, or 8 bytes. [cite_start]Uses RDS biphase modulation (PSK). [cite: 427, 431]

---

## 3. Commands

[cite_start]Commands consist of a 3-bit identifier followed by parameters. [cite: 267]

| Command | ID (Bin) | Description | Parameters / Structure |
| :--- | :--- | :--- | :--- |
| **No Command** | (none) | Ping / ACK check | [cite_start]Address + CRC only. [cite: 490] |
| **Drive (Short)** | `000` | Low res speed | [cite_start]`R SSS` (R=Dir, S=Speed steps 0, 16, 32...). [cite: 493] |
| **Drive** | `001` | Full speed control | [cite_start]`R SSSSSS` (127 steps). [cite: 504] |
| **Func (Short)** | `010` | F0-F3 | [cite_start]`FFFF` (F3 F2 F1 F0). [cite: 513] |
| **Func (Ext)** | `011` | F0-F15 | [cite_start]`O FFFFFFFF` (8 or 16 bit mask). [cite: 519] |
| **Func (Indiv)** | `100` | Control single F | [cite_start]`NNNNNNN 0 F` (N=Func Index, F=State). [cite: 526] |
| **Config** | `111` | **Meta-Command** | [cite_start]See "Configuration Commands" below. [cite: 534] |

### [cite_start]Configuration Commands (ID `111`) [cite: 542]

* **Read CV:** `111 000 [Address 16-bit] [Count]`
    * [cite_start]Reads 1, 2, 4, or 8 bytes. [cite: 544]
* **Write CV:** `111 001 [Address 16-bit] 00 [Data 8-bit]`
    * [cite_start]Writes 1 byte. [cite: 551]
* **Decoder Search:** `111 010 [C] [UID Fragment]`
    * Used for discovery. [cite_start]Decoders match UID bits to respond. [cite: 557]
* **Assign Address:** `111 011 [SID 14-bit] [UID 32-bit]`
    * [cite_start]Assigns short SID to a specific UID. [cite: 563]
* **Verify (Ping):** `111 100 [UID 32-bit]`
    * [cite_start]Checks existence of a registered decoder. [cite: 570]
* **Central Station:** `111 101 [UID Central] [Counter]`
    * Broadcasts central station ID and registration counter. [cite_start]Forces re-registration if mismatch. [cite: 580]

---

## 4. Protocol Workflow

### [cite_start]4.1 Registration Process [cite: 635]
1.  **Discovery:** Central sends `DecoderSearch`. Unregistered decoders respond.
2.  **Identification:** Binary search on UID to isolate a single decoder.
3.  **Assignment:** Central sends `Assign Address` to map UID to a SID.
4.  **Readout:** Central reads decoder configuration (CVs) to determine capabilities.

### [cite_start]4.2 mfx+ (Game World) [cite: 780]
* Simulates consumption of resources (Fuel, Water, Sand).
* **States:** Active only in mfx+ mode.
* **Feedback:** Decoder calculates consumption based on load/speed; [cite_start]Central queries status periodically. [cite: 786]

---

## 5. Decoder Configuration (CV Structure)

[cite_start]**Addressing:** 16-bit Address = 10-bit CV Number + 6-bit Index. [cite: 881]
**Structure:** Organized in **Blocks** -> **Groups** -> **Configuration Arrays (CA)**.

### [cite_start]5.1 The Block Directory (CV 004) [cite: 1085]
A special list at CV 004 (Index 1-n) points to the start addresses of other blocks.

### 5.2 Detailed Block Definitions

#### [cite_start]**Block 01: Decoder Properties** [cite: 1109]
* **CA Type 10:** Manufacturer ID & Product ID.
* **CA Type 11:** Production Date.
* **CA Type 12/13:** Firmware Versions (Bootloader / App).
* [cite_start]**CA Type 16:** Locomotive Info (Icon, Type, Article Number). [cite: 1200]
* [cite_start]**CA Type 18:** Locomotive Name (UTF-8 String). [cite: 1231]

#### [cite_start]**Block 02: Functions** [cite: 1262]
* Maps logical functions to hardware or functional indices.

#### [cite_start]**Block 04: Function Mapping** [cite: 1292]
* [cite_start]**CA Type 10 (Symbol):** Defines the icon (Light, Sound, Telex, etc.) and behavior (Momentary vs Continuous). [cite: 1300]
* [cite_start]**CA Type 12 (Forward):** Bitmask of active outputs when moving forward. [cite: 1411]
* [cite_start]**CA Type 13 (Reverse):** Bitmask of active outputs when reversing. [cite: 1427]

#### [cite_start]**Block 05: Drive Characteristics** [cite: 1434]
* [cite_start]**CA Type 10/11:** Motor Type (DC, Soft/Hard, SDS, Bell-armature). [cite: 1439]
* [cite_start]**CA Type 12:** PWM Frequency. [cite: 1462]
* [cite_start]**CA Type 13:** Accel/Decel Delay (Inertia). [cite: 1473]
* [cite_start]**CA Type 15:** Load Control (PID parameters: K, I, Reference). [cite: 1491]
* [cite_start]**CA Type 17:** Speed Table (26 interpolation points). [cite: 1509]

#### [cite_start]**Block 06: Hardware Outputs** [cite: 1529]
* **CA Type 10:** Output Config (Light, Smoke, Telex, Strobe).
    * [cite_start]Includes Dimming (0-255) and Period/Frequency. [cite: 1533]
* [cite_start]**CA Type 11:** Internal Functions (Shunting gear, Brake squeal volume). [cite: 1569]

#### [cite_start]**Block 07: Alternative Protocols** [cite: 1598]
* Configures behavior for Analog AC/DC, MM (Motorola), and DCC.
* [cite_start]**CA Type 13 (MM):** Defines additional MM addresses (Sequence of 4). [cite: 1639]
* [cite_start]**CA Type 13 (DCC):** Short/Long Address configuration. [cite: 1682]

#### [cite_start]**Block 08: Sound** [cite: 1700]
* [cite_start]**CA Type 10:** Master Volume. [cite: 1702]
* [cite_start]**CA Type 14:** Random Sounds (Min/Max intervals). [cite: 1744]
* [cite_start]**CA Type 15:** Brake Squeal Threshold. [cite: 1751]

#### [cite_start]**Block 0A: mfx+ (Game World)** [cite: 1798]
* [cite_start]**CA Type 10:** Current levels (Fuel A, Fuel B, Sand). [cite: 1799]
* [cite_start]**CA Type 11:** Max capacity definitions. [cite: 1809]
* [cite_start]**CA Type 12:** Consumption factors. [cite: 1821]
* **CA Type 15/16:** Odometer (Total Time / Total Distance). [cite_start]Read-only. [cite: 1853]

---
**End of Specification Summary**
